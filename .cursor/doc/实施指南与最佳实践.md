# 实施指南与最佳实践

## 🚀 实施路线图

### 第一阶段: 基础设施 (Week 1-2)

```bash
# 1. 初始化TypeScript项目
pnpm create vite threejs-editor-v3 --template vue-ts
cd threejs-editor-v3

# 2. 安装核心依赖
pnpm add vue@^3.5 vue-router@^4 pinia@^2.2
pnpm add three@^0.179 @tweenjs/tween.js@^18
pnpm add element-plus@^2.8 @element-plus/icons-vue
pnpm add @vueuse/core@^11 mitt@^3

# 3. 安装开发依赖
pnpm add -D typescript@^5 vite@^5
pnpm add -D @vitejs/plugin-vue @vitejs/plugin-vue-jsx
pnpm add -D sass unplugin-auto-import unplugin-vue-components
pnpm add -D eslint@^9 prettier@^3 vitest@^2
pnpm add -D @types/three @types/node
```

### 第二阶段: 核心Composables (Week 3-4)

**优先级顺序:**

1. ✅ useThreeScene (最高优先级)
2. ✅ useThreeRenderer
3. ✅ useThreeCamera
4. ✅ useThreeControls
5. ✅ useModelLoader
6. ✅ useDragCore (拖拽核心)
7. ✅ useRaycast (射线检测)

### 第三阶段: 编辑器功能 (Week 5-8)

**功能模块顺序:**

1. 材质系统 → 2. 灯光系统 → 3. 背景系统 →
2. 动画系统 → 5. 后期效果 → 6. 拖拽系统 →
3. 几何体系统 → 8. 标签系统 → 9. 着色器系统

### 第四阶段: 完善与优化 (Week 9-12)

- Week 9-10: 组件迁移
- Week 11: 测试编写
- Week 12: 性能优化和文档

---

## 💡 最佳实践

### 1. Composable 编写规范

```typescript
/**
 * ✅ 标准Composable模板
 */
export function useXxx(config?: XxxConfig) {
  // 1. 依赖注入
  const store = useXxxStore();
  const eventBus = useEventBus();

  // 2. 响应式状态 (使用shallowRef优化Three.js对象)
  const state = shallowRef<THREE.Object3D | null>(null);
  const loading = ref(false);

  // 3. 计算属性
  const isReady = computed(() => state.value !== null);

  // 4. 方法
  const doSomething = () => {
    // 实现逻辑
  };

  // 5. 生命周期
  onUnmounted(() => {
    // 清理资源
  });

  // 6. 返回API (状态使用readonly)
  return {
    state: readonly(state),
    loading: readonly(loading),
    isReady,
    doSomething,
  };
}
```

### 2. Store 编写规范

```typescript
/**
 * ✅ 标准Setup Store模板
 */
export const useXxxStore = defineStore('xxx', () => {
  // 1. State (Three.js对象使用shallowRef)
  const object = shallowRef<THREE.Object3D | null>(null);
  const config = ref<XxxConfig>({});

  // 2. Getters (使用computed)
  const isActive = computed(() => object.value !== null);

  // 3. Actions (普通函数)
  function setObject(newObject: THREE.Object3D) {
    object.value = newObject;
  }

  function reset() {
    object.value = null;
    config.value = {};
  }

  // 4. 返回公开API
  return {
    // State
    object,
    config,

    // Getters
    isActive,

    // Actions
    setObject,
    reset,
  };
});
```

### 3. 组件编写规范

```vue
<!-- ✅ 标准组件模板 -->
<script setup lang="ts">
// 1. 类型导入
import type { PropType } from 'vue';

// 2. 接口定义
interface Props {
  title: string;
  modelUrl?: string;
}

interface Emits {
  (e: 'update', value: any): void;
}

// 3. Props定义
const props = defineProps<Props>();

// 4. Emits定义
const emit = defineEmits<Emits>();

// 5. Composables
const { scene } = useThreeScene();

// 6. 响应式状态
const loading = ref(false);

// 7. 计算属性
const isReady = computed(() => !loading.value);

// 8. 方法
const handleUpdate = () => {
  emit('update', {});
};

// 9. 生命周期
onMounted(() => {
  // 初始化
});
</script>

<template>
  <div class="component">
    <!-- 模板 -->
  </div>
</template>

<style scoped lang="scss">
.component {
  // 样式
}
</style>
```

---

## 🧪 测试策略

### 单元测试示例

```typescript
// tests/unit/composables/useMaterialEditor.spec.ts
import { describe, it, expect, beforeEach } from 'vitest';
import { useMaterialEditor } from '@/composables/editor/material/useMaterialEditor';
import * as THREE from 'three';

describe('useMaterialEditor', () => {
  let material: THREE.MeshStandardMaterial;

  beforeEach(() => {
    material = new THREE.MeshStandardMaterial({ color: 0xff0000 });
  });

  it('应该正确选择材质', () => {
    const { selectMaterial, selectedMaterial } = useMaterialEditor();

    selectMaterial(material);

    expect(selectedMaterial.value).toBe(material);
  });

  it('应该正确更新颜色', () => {
    const { selectMaterial, updateColor } = useMaterialEditor();

    selectMaterial(material);
    updateColor(0x00ff00);

    expect(material.color.getHex()).toBe(0x00ff00);
  });
});
```

---

## ⚡ 性能优化清单

### Three.js 性能优化

- [ ] 使用shallowRef存储Three.js对象
- [ ] 几何体复用（InstancedMesh）
- [ ] 材质复用
- [ ] 纹理压缩（KTX2）
- [ ] 几何体合并
- [ ] LOD层级细节
- [ ] 视锥体剔除
- [ ] 按需渲染

### Vue 性能优化

- [ ] 虚拟滚动（模型列表）
- [ ] 懒加载路由
- [ ] 组件异步加载
- [ ] v-memo优化列表
- [ ] KeepAlive缓存
- [ ] 计算属性优化
- [ ] Watch优化（deep: false）

---

## 📝 迁移检查清单

### 代码迁移

- [ ] TypeScript配置完成
- [ ] 所有类型定义完成
- [ ] 核心Composables实现
- [ ] Stores迁移完成
- [ ] 组件迁移完成
- [ ] 工具函数迁移
- [ ] 常量配置迁移

### 测试覆盖

- [ ] Composables单元测试 (>80%)
- [ ] Stores单元测试 (>80%)
- [ ] 组件测试 (>60%)
- [ ] E2E测试 (核心流程)

### 文档完善

- [ ] API文档
- [ ] 开发指南
- [ ] 部署指南
- [ ] 故障排查

---

## 🎯 成功指标

| 指标         | 目标    | 测量方式            |
| ------------ | ------- | ------------------- |
| **代码行数** | 减少20% | wc -l               |
| **类型覆盖** | 100%    | tsc --noEmit        |
| **测试覆盖** | >80%    | vitest --coverage   |
| **构建时间** | <30s    | vite build          |
| **包体积**   | <2MB    | vite build --report |
| **FPS**      | >60     | Chrome DevTools     |

---

## 📚 参考资源

- [Vue 3 官方文档](https://vuejs.org/)
- [Pinia 官方文档](https://pinia.vuejs.org/)
- [Three.js 官方文档](https://threejs.org/docs/)
- [VueUse 文档](https://vueuse.org/)
- [TypeScript 手册](https://www.typescriptlang.org/docs/)
